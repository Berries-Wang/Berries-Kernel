# 编译内核
基于[000.使用BusyBox制作最小文件系统](./000.使用BusyBox制作最小文件系统.md) , 开始编译内核

## 开始编译内核
1. 编译内核
   ```txt
    #1. 需要在内核文件目录
    wei@Berries-Wang:~/OPEN_SOURCE/Berries-Kernel/000.SOURCE_CODE/000.LINUX-5.9/000.LINUX-5.9$ export ARCH=arm
    wei@Berries-Wang:~/OPEN_SOURCE/Berries-Kernel/000.SOURCE_CODE/000.LINUX-5.9/000.LINUX-5.9$ export CROSS_COMPILE=arm-linux-gnueabi-
    wei@Berries-Wang:~/OPEN_SOURCE/Berries-Kernel/000.SOURCE_CODE/000.LINUX-5.9/000.LINUX-5.9$ make vexpress_defconfig
    wei@Berries-Wang:~/OPEN_SOURCE/Berries-Kernel/000.SOURCE_CODE/000.LINUX-5.9/000.LINUX-5.9$ make menuconfig
   ```

2. 配置 initramfs，在 initramfs source file 中填入_install，并把 Default kernel command string清空。
   - ![kernel_2024-12-14_141834_521.png](./IMGS/kernel_2024-12-14_141834_521.png)
   - ![kernel_2024-12-14_141919_646.png](./IMGS/kernel_2024-12-14_141919_646.png)

3. 配置 memory split 为“3G/1G user/kernel split”
   - ![kernel_2024-12-14_142010_184.png](./IMGS/kernel_2024-12-14_142010_184.png)
   - ![kernel_2024-12-14_142034_330.png](./IMGS/kernel_2024-12-14_142034_330.png)
4. 编译内核
   ```txt
      wei@Berries-Wang:~/OPEN_SOURCE/Berries-Kernel/000.SOURCE_CODE/000.LINUX-5.9/000.LINUX-5.9$ make bzImage ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-
      wei@Berries-Wang:~/OPEN_SOURCE/Berries-Kernel/000.SOURCE_CODE/000.LINUX-5.9/000.LINUX-5.9$ make dtbs
   ```
5. 运行 QEMU 来模拟 4 核 Cortex-A9 的 Versatile Express 开发平台。
   ```txt
      qemu-system-arm -M vexpress-a9 -smp 4 -m 1024M -kernel arch/arm/boot/zImage -append "rdinit=/linuxrc console=ttyAMA0 loglevel=8" -dtb arch/arm/boot/dts/vexpress-v2p-ca9.dtb -nographic
   ```
   - 输出日志如下
     ```txt
        drm-clcd-pl111 10020000.clcd: [drm] fb0: pl111drmfb frame buffer device
        ALSA device list:
          #0: ARM AC'97 Interface PL041 rev0 at 0x10004000, irq 24
        Freeing unused kernel memory: 2048K
        Run /linuxrc as init process
          with arguments:
            /linuxrc
          with environment:
            HOME=/
            TERM=linux
        mount: mounting debugfs on /sys/kernel/debug failed: No such file or directory
        /etc/init.d/rcS: line 8: can't create /proc/sys/kernel/hotplug: nonexistent directory
        input: ImExPS/2 Generic Explorer Mouse as /devices/platform/bus@4000000/bus@4000000:motherboard/bus@4000000:motherboard:iofpga@7,00000000/10007000.kmi/serio1/input/input2
        
        Please press Enter to activate this console. random: fast init done
        
        ~ # whoami
        whoami: unknown uid 0
        ~ # ls
     ```