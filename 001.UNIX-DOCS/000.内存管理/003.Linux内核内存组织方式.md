# Linux内核内存组织方式<sub>即 一张内存条在Linux内核中是怎么被组织起来的</sub>
> 先学习:[Run Linux Kernel (2nd Edition) Volume 1: Infrastructure.epub]#第3章　内存管理之预备知识

## 背景
在大部分Linux操作系统中，内存设备的初始化一般在BIOS或BootLoader中完成，然后把DDR存储设备的大小传递给Linux内核，因此，从内核的角度看，DDR存储设备其实就是一段物理内存空间。

在Linux内核中，和内存硬件物理特性相关的一些数据结构主要集中在MMU(如页表、高速缓存/TLB操作等)中。 因此大部分的Linux内核中关于内存管理的相关数据结构是软件层面的概念，如mm ， VMA、内存管理区(zone)、页面、page_data等。

## 物理内存管理相关的数据结构
和物理内存管理相关的数据结构: pglist_data 、 内存管理区(zone)、物理页面（page）、mem_map[]数组、页表项(PTE) 、 页帧号(PFN)、物理地址（paddress）

### pglist_data
描述一个内存节点的所有资源， 在UMA架构中，只有一个内存节点,即系统有一个全局的变量contig_page_data来描述这个内存节点;在NUMA架构中，整个系统的内存由一个 pglist_data*的指针数组node_data[]来管理,在系统初始化时通过枚举BIOS固件来完成。

## Linux内核内存组织方式
> 000.LINUX-5.9/include/linux/mmzone.h
```txt
node_data-整个系统的内存 -> 'struct pglist_data *node_data[MAX_NUMNODES] __read_mostly;'
└── pglist_data- 和NUMA UMA(SMP架构有关),而不是单独对应物理层面上的一个内存条: Linux 内核中用于管理单个 Node 上所有物理内存的核心结构体。它包含该 Node 的统计信息、它所包含的 Zone 列表等。
    └── zone-内存区域划分 (一个 struct zone 对应于一个 NUMA 节点上的一段特定物理地址范围)
        └── free_area-组织不同页块(伙伴系统的核心数据结构，管理空闲页块（page block）链表的数组)

mem_map： 将整个物理内存使用页(page)表示，将这些页用mem_map组织表示
      见[Run Linux Kernel (2nd Edition) Volume 1: Infrastructure.epub]#图3.9　mem_map[]数组和物理页面的关系

页帧号（PFN): 即页面再mem_map数组中的下标

为什么你的电脑只有一个Node 0 (cat /proc/zoneinfo) - 实际内存条数量: 2
    - NUMA（Non-Uniform Memory Access） 架构下，多个内存控制器会划分不同的 Node（每个 Node 对应一个物理 CPU 或内存区域）。
    - 普通台式机/笔记本 通常采用 UMA（Uniform Memory Access） 架构（即使有多根内存条），所有内存由单一内存控制器管理，因此内核默认只有一个 Node 0。
       + 即 台式机/笔记本 没有开启(或不支持NUMA) ， 所以，即使插了多根内存条，那么他也只有一个Node
    - 服务器/工作站（如 AMD EPYC、Intel Xeon）可能启用 NUMA，插多根内存条会分配到不同 Node（例如 Node 0 和 Node 1）。

```
