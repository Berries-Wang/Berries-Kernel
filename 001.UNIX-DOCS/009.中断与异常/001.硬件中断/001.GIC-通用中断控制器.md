# Generic Interrupt Controller(通用中断控制器-GIC)
> 先学习: [Learn the architecture - Generic Interrupt Controller v3 and v4, Overview](../../006.REFS/learn_the_architecture_-_generic_interrupt_controller_v3_and_v4__overview_198123_0302_03_en.pdf)<sup>内容很丰富: 1. Group priority| Subpriority（对照STM32 NVIC配置更好理解：在STM32中使用NVIC时需要手动配置的: 即 为什么要配置优先级组） <br/> 2. 其他，待补充</sup> 或 [Learn the architecture - Generic Interrupt Controller v3 and v4, Overview @link](https://developer.arm.com/documentation/198123/0302?lang=en) & [Arm® CoreLink™ GIC-700 Generic Interrupt
Controller](../../../007.BOOKs/corelink_gic_700_generic_interrupt_controller_trm_101516_0400_12_en.pdf) <sup>或者先读一下v2中文版: [Run Linux Kernel (2nd Edition) Volume 2: Debugging and Case Analysis#2.1　中断控制器](../../001.UNIX-DOCS/../007.BOOKs/Run%20Linux%20Kernel%20(2nd%20Edition))</sup>

> 结合 [Run Linux Kernel (2nd Edition) Volume 2: Debugging and Case Analysis.epub]#2.4　ARM64底层中断处理 来学习

## PE 
PE（Processing Element，处理单元） 是 ARM 官方文档中对 可独立执行指令的硬件处理单元 的标准化术语

---

## 异常处理流程
- 详细阅读:[Run Linux Kernel (2nd Edition) Volume 2: Debugging and Case Analysis#2.1　中断控制器](../../001.UNIX-DOCS/../007.BOOKs/Run%20Linux%20Kernel%20(2nd%20Edition)) & [Run Linux Kernel (2nd Edition) Volume 2: Debugging and Case Analysis#2.1.1　中断状态和中断触发方式](../../001.UNIX-DOCS/../007.BOOKs/Run%20Linux%20Kernel%20(2nd%20Edition)) & [Run Linux Kernel (2nd Edition) Volume 2: Debugging and Case Analysis#2.1.1　中断状态和中断触发方式](../../001.UNIX-DOCS/../007.BOOKs/Run%20Linux%20Kernel%20(2nd%20Edition))

### EOI（End of interrupt）<sup>说明: 1. 中断需要尽快处理 <br/> 2. </sup>
> 阅读: [Generic Interrupt Controller：pdf](../../006.REFS/learn_the_architecture_-_generic_interrupt_controller_v3_and_v4__overview_198123_0302_03_en.pdf) , 搜索 EOI 或 End of interrupt

The Priority Mask register sets the minimum priority that an interrupt must have to be forwarded to the PE. The GICv3 architecture also has the concept of a running priority. When a PE acknowledges an interrupt, its running priority becomes the same as the priority of the interrupt. The running priority returns to its former value when the PE writes to one of the End of Interrupt (EOI) registers.(优先级掩码（Priority Mask）寄存器设置了中断被转发至处理单元（PE）所必须达到的最低优先级。GICv3 架构还引入了‘运行优先级（Running Priority）’的概念。当 PE 确认（Acknowledge）一个中断时，其运行优先级会变得与该中断的优先级相同。直到 PE 写入其中一个中断结束（EOI）寄存器后，运行优先级才会恢复到之前的值。)

Once the interrupt has been handled, software must inform the interrupt controller that the interrupt has been handled, so that the state machine can transition to the next state(一旦中断处理完毕，软件必须通知中断控制器该中断已处理完成，以便状态机能够切换到下一个状态。)
+ 所以，当中断处理完毕后，必须通过写 EOI 寄存器来通知 GIC 中断已经处理完毕。<sup>当处理器完成中断服务，必须发送一个完成信号结束中断（End Of Interrupt，EOI）给GIC: [Run Linux Kernel (2nd Edition) Volume 2: Debugging and Case Analysis.epub#2．中断流程](../../../007.BOOKs/Run%20Linux%20Kernel%20(2nd%20Edition)%20Volume%202:%20Debugging%20and%20Case%20Analysis.epub)</sup>
  - 所以，中断需要尽快处理完毕，不能长时间占用 CPU，否则会影响其他中断的响应时间。



## 通用计时器中断
> 来自文档的 `Arm GIC fundamentals` 部分

Private Peripheral Interrupt (PPI). Peripheral interrupts that are private to one core. An example of a PPI is an interrupt from the Generic Timer.（私有外设中断 (PPI)。指仅供单个核心使用的外设中断。例如，来自通用定时器的中断就是一个 PPI 中断。）

+ ![254a87ca-bff6-4434-88d0-af2dee1f4c86.png](../../999.IMGS/254a87ca-bff6-4434-88d0-af2dee1f4c86.png)

---

### GIC 类型划分 <sup>?待确认</sup>
对 GIC 来说，中断可以分成以下几种类型：ARMPG
- SGI(Software Generated Interrupt)，Interrupt IDs 0-15。系统一般用其来实现 IPI 中断。
- PPI(Private Peripheral Interrupt)，Interrupt IDs16-31。私有中断，这种中断对每个 CPU 都是独立一份的，比如 per-core timer 中断。
- SPI(Shared Peripheral Interrupt)，Interrupt numbers 32-1020。最常用的外设中断，中断可以发给一个或者多个 CPU。
- LPI(Locality-specific Peripheral Interrupt)。基于 message 的中断，GICv2 和 GICv1 中不支持。

---

## 参考资料
+ [Generic Interrupt Controller：pdf](../../../006.REFS/learn_the_architecture_-_generic_interrupt_controller_v3_and_v4__overview_198123_0302_03_en.pdf)
+ [Generic Interrupt Controller](https://developer.arm.com/documentation/198123/0302?lang=en)
+ [https://kernel.meizu.com/2016/09/02//linux-interrupt.html/#fn_ARMPG](https://kernel.meizu.com/2016/09/02//linux-interrupt.html/#fn_ARMPG)