# memory.max

## 测试目的
测试 cgroup v2 中 memory 子系统的内存使用上限限制功能。

## 测试环境
- 操作系统: Ubuntu 22.04 LTS
- 内核版本: [Sun Jan 11 13:46:10 2026] Linux version 5.15.0-164-generic (buildd@lcy02-amd64-114) (gcc (Ubuntu 11.4.0-1ubuntu1~22.04.2) 11.4.0, GNU ld (GNU Binutils for Ubuntu) 2.38) #174-Ubuntu SMP Fri Nov 14 20:25:16 UTC 2025 (Ubuntu 5.15.0-164.174-generic 5.15.193)
- cgroup 版本: v2

## 测试步骤
1. 创建 cgroup v2 的挂载点并挂载:
   ```bash
      sudo mkdir /sys/fs/cgroup/test_cgroup
      ubuntu@ubuntu-server:/sys/fs/cgroup/test_cgroup$ ls
      cgroup.controllers  cgroup.max.descendants  cgroup.type    cpuset.cpus            cpu.stat         io.max         memory.current       memory.max        memory.stat          pids.current
      cgroup.events       cgroup.procs            cpu.idle       cpuset.cpus.effective  cpu.uclamp.max   io.pressure    memory.events        memory.min        memory.swap.current  pids.events
      cgroup.freeze       cgroup.stat             cpu.max        cpuset.cpus.partition  cpu.uclamp.min   io.prio.class  memory.events.local  memory.numa_stat  memory.swap.events   pids.max
      cgroup.kill         cgroup.subtree_control  cpu.max.burst  cpuset.mems            cpu.weight       io.stat        memory.high          memory.oom.group  memory.swap.high
      cgroup.max.depth    cgroup.threads          cpu.pressure   cpuset.mems.effective  cpu.weight.nice  io.weight      memory.low           memory.pressure   memory.swap.max
   ```

2. 创建一个新的程序
   ```c
      #include<stdio.h>
      #include <stdlib.h>
      
      
      int main(int argc , char**argv)
      {
      
      	printf("sizeof(char): %ld byte \n",sizeof(char));
      	int size = 120 * 1024 * 1024;
      	char * buffer = (char*)malloc(size * sizeof(char));
      	for(int i =0;i<size;i++){
      		buffer[i] = 'a';
      	}
      	printf("Hello CGroup\n");
      
      	free(buffer);
      	return 0;
      }

   ```

3. 将cgroup的memory.max设置为100MB:
   ```bash
      echo 104857600 | sudo tee /sys/fs/cgroup/test_cgroup/memory.max
 
      # 关闭swap , 不然不会触发oom-killer
      ubuntu@ubuntu-server:~$ sudo su - 
      root@ubuntu-server:~# echo 0 > /sys/fs/cgroup/test_cgroup/memory.swap.max
   ```

4. 当前 shell 加入该组，然后启动程序。这样该 shell 派生的所有子进程都会受限于该 cgroup:
   ```bash
      echo $$ | sudo tee /sys/fs/cgroup/test_cgroup/cgroup.procs
      gcc cgroup_memory_max.c -o app
      ./app

      ubuntu@ubuntu-server:~$ ./app 
      sizeof(char): 1 byte 
      Killed
   ```

5. 查看 dmesg 日志，可以看到 oom-killer 杀死了该进程:
   ```bash
      [Sun Jan 11 13:46:16 2026] IPv6: ADDRCONF(NETDEV_CHANGE): enp0s3: link becomes ready
      [Sun Jan 11 13:46:22 2026] loop5: detected capacity change from 0 to 8
      [Sun Jan 11 14:05:44 2026] app invoked oom-killer: gfp_mask=0x1100cca(GFP_HIGHUSER_MOVABLE), order=0, oom_score_adj=0
      [Sun Jan 11 14:05:44 2026] CPU: 0 PID: 1888 Comm: app Not tainted 5.15.0-164-generic #174-Ubuntu
      [Sun Jan 11 14:05:44 2026] Hardware name: innotek GmbH VirtualBox/VirtualBox, BIOS VirtualBox 12/01/2006
      [Sun Jan 11 14:05:44 2026] Call Trace:
      [Sun Jan 11 14:05:44 2026]  <TASK>
      [Sun Jan 11 14:05:44 2026]  show_stack+0x52/0x5c
      [Sun Jan 11 14:05:44 2026]  dump_stack_lvl+0x4a/0x63
      [Sun Jan 11 14:05:44 2026]  dump_stack+0x10/0x16
      [Sun Jan 11 14:05:44 2026]  dump_header+0x53/0x23c
      [Sun Jan 11 14:05:44 2026]  oom_kill_process.cold+0xb/0x10
      [Sun Jan 11 14:05:44 2026]  out_of_memory+0x106/0x2e0
      [Sun Jan 11 14:05:44 2026]  ? srso_alias_return_thunk+0x5/0x7f
      [Sun Jan 11 14:05:44 2026]  mem_cgroup_out_of_memory+0x13f/0x160
      [Sun Jan 11 14:05:44 2026]  try_charge_memcg+0x687/0x740
      [Sun Jan 11 14:05:44 2026]  ? srso_alias_return_thunk+0x5/0x7f
      [Sun Jan 11 14:05:44 2026]  ? kernel_init_free_pages.part.0+0x4a/0x70
      [Sun Jan 11 14:05:44 2026]  ? srso_alias_return_thunk+0x5/0x7f
      [Sun Jan 11 14:05:44 2026]  ? get_page_from_freelist+0x356/0x520
      [Sun Jan 11 14:05:44 2026]  ? kernel_init_free_pages.part.0+0x4a/0x70
      [Sun Jan 11 14:05:44 2026]  charge_memcg+0x45/0xb0
      [Sun Jan 11 14:05:44 2026]  __mem_cgroup_charge+0x2d/0x90
      [Sun Jan 11 14:05:44 2026]  __add_to_page_cache_locked+0x2d8/0x350
      [Sun Jan 11 14:05:44 2026]  ? scan_shadow_nodes+0x40/0x40
      [Sun Jan 11 14:05:44 2026]  add_to_page_cache_lru+0x4d/0xd0
      [Sun Jan 11 14:05:44 2026]  pagecache_get_page+0x192/0x590
      [Sun Jan 11 14:05:44 2026]  ? srso_alias_return_thunk+0x5/0x7f
      [Sun Jan 11 14:05:44 2026]  ? page_cache_ra_unbounded+0x163/0x210
      [Sun Jan 11 14:05:44 2026]  filemap_fault+0x488/0xab0
      [Sun Jan 11 14:05:44 2026]  ? srso_alias_return_thunk+0x5/0x7f
      [Sun Jan 11 14:05:44 2026]  ? filemap_map_pages+0x309/0x400
      [Sun Jan 11 14:05:44 2026]  __do_fault+0x3c/0x120
      [Sun Jan 11 14:05:44 2026]  do_read_fault+0xeb/0x160
      [Sun Jan 11 14:05:44 2026]  do_fault+0xa0/0x2e0
      [Sun Jan 11 14:05:44 2026]  handle_pte_fault+0x1cd/0x240
      [Sun Jan 11 14:05:44 2026]  __handle_mm_fault+0x405/0x6f0
      [Sun Jan 11 14:05:44 2026]  handle_mm_fault+0xd8/0x2c0
      [Sun Jan 11 14:05:44 2026]  do_user_addr_fault+0x1c9/0x640
      [Sun Jan 11 14:05:44 2026]  exc_page_fault+0x77/0x170
      [Sun Jan 11 14:05:44 2026]  asm_exc_page_fault+0x27/0x30
      [Sun Jan 11 14:05:44 2026] RIP: 0033:0x561c9098a203
      [Sun Jan 11 14:05:44 2026] Code: Unable to access opcode bytes at RIP 0x561c9098a1d9.
      [Sun Jan 11 14:05:44 2026] RSP: 002b:00007fff7fc29710 EFLAGS: 00010206
      [Sun Jan 11 14:05:44 2026] RAX: 00007f76b155b000 RBX: 0000000000000000 RCX: 00007f76b2b3ca97
      [Sun Jan 11 14:05:44 2026] RDX: 0000000006340ff0 RSI: 0000000007801000 RDI: 0000000000000000
      [Sun Jan 11 14:05:44 2026] RBP: 00007fff7fc29730 R08: 00007f76ab21a010 R09: 00007f76ab21a010
      [Sun Jan 11 14:05:44 2026] R10: 0000000000000022 R11: 0000000000000246 R12: 00007fff7fc29848
      [Sun Jan 11 14:05:44 2026] R13: 0000561c9098a1a9 R14: 0000561c9098cda8 R15: 00007f76b2c89040
      [Sun Jan 11 14:05:44 2026]  </TASK>
      [Sun Jan 11 14:05:44 2026] memory: usage 102400kB, limit 102400kB, failcnt 17035
      [Sun Jan 11 14:05:44 2026] swap: usage 256kB, limit 0kB, failcnt 0
      [Sun Jan 11 14:05:44 2026] Memory cgroup stats for /test_cgroup:
      [Sun Jan 11 14:05:44 2026] anon 104538112
                                 file 4096
                                 kernel_stack 16384
                                 pagetables 237568
                                 percpu 0
                                 sock 0
                                 shmem 0
                                 file_mapped 0
                                 file_dirty 0
                                 file_writeback 0
                                 swapcached 8192
                                 anon_thp 0
                                 file_thp 0
                                 shmem_thp 0
                                 inactive_anon 104538112
                                 active_anon 4096
                                 inactive_file 0
                                 active_file 0
                                 unevictable 0
                                 slab_reclaimable 9096
                                 slab_unreclaimable 21960
                                 slab 31056
                                 workingset_refault_anon 496
                                 workingset_refault_file 5
                                 workingset_activate_anon 0
                                 workingset_activate_file 0
                                 workingset_restore_anon 0
                                 workingset_restore_file 0
                                 workingset_nodereclaim 0
                                 pgfault 208169
                                 pgmajfault 217
                                 pgrefill 29
                                 pgscan 181143
                                 pgsteal 26746
                                 pgactivate 25
                                 pgdeactivate 23
                                 pglazyfree 0
                                 pglazyfreed 0
                                 thp_fault_alloc 0
                                 thp_collapse_alloc 0
      [Sun Jan 11 14:05:44 2026] Tasks state (memory values in pages):
      [Sun Jan 11 14:05:44 2026] [  pid  ]   uid  tgid total_vm      rss pgtables_bytes swapents oom_score_adj name
      [Sun Jan 11 14:05:44 2026] [   1113]  1000  1113     2217     1471    61440        3             0 bash
      [Sun Jan 11 14:05:44 2026] [   1888]  1000  1888    31415    25752   249856        0             0 app
      [Sun Jan 11 14:05:44 2026] oom-kill:constraint=CONSTRAINT_MEMCG,nodemask=(null),cpuset=test_cgroup,mems_allowed=0,oom_memcg=/test_cgroup,task_memcg=/test_cgroup,task=app,pid=1888,uid=1000
      [Sun Jan 11 14:05:44 2026] Memory cgroup out of memory: Killed process 1888 (app) total-vm:125660kB, anon-rss:101688kB, file-rss:1320kB, shmem-rss:0kB, UID:1000 pgtables:244kB oom_score_adj:0
      ubuntu@ubuntu-server:~$ 
   ```