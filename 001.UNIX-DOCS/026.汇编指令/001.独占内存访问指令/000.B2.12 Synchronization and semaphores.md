# B2.12 Synchronization and semaphores
> 全文记录没有意义，只做摘要

## Store-Exclusive 是够更新内存的前提条件
Whether a Store-Exclusive instruction successfully updates memory or not depends on whether the address accessed matches the marked shareable memory address for the PE issuing the Store-Exclusive instruction, and whether the local and global monitors are in the exclusive state. For this reason, Figure B2-5 shows only how the operations by (!n) cause state transitions of the state machine for PE(n)
```txt
存储独占（Store-Exclusive）指令能否成功更新内存，取决于以下两个条件：
  1. 访问的地址是否与发出存储独占指令的处理单元（PE）所标记的可共享内存地址匹配；
  2. 本地监视器（local monitor）和全局监视器（global monitor）是否均处于独占状态。
```

## B2.12.3 Marking and the size of the marked memory block
> 加载/存储-独占指令会对内存块进行标记(`标记为独占访问`)，例如，LDXRB会对内存块进行标记 
>> 怎么标记为独占访问的?
```en
   For example, in an implementation where a is 4, a successful LDXRB of address 0x341B4 defines a marked block using bits[47:4] of the address. This means that the four words of memory from 0x341B0 to 0x341BF are marked for exclusive access.
```
### QA
##### 32位执行模式下，又是怎样的情况呢?

---

## B2.12.5 Load-Exclusive and Store-Exclusive instruction usage restrictions<sup>限制条件</sub>
### 虚拟地址（VA）得一致
  ```txt
   This means software can rely on a LoadExcl/StoreExcl pair to eventually succeed only if the LoadExcl and the StoreExcl are executed with the same VA

   这意味着只有在加载-独占指令和存储独占指令执行相同虚拟地址的情况下，软件能够依赖于LoadExcl/StoreExcl指令对最终执行成功
  ```

### 操作的内存大小（事务大小）得一致 [可选]
```c
This means software can rely on a LoadExcl/StoreExcl pair to eventually succeed only if the LoadExcl and the StoreExcl have the same transaction size.
```

但是这个是由实现者选择实现性实现的:
```
An implementation of the Load-Exclusive and Store-Exclusive instructions can require that, in any thread of execution, the transaction size of a StoreExcl instruction is the same as the transaction size of the preceding LoadExcl instruction executed in that thread. If the transaction size of a StoreExcl instruction is different from the preceding LoadExcl instruction in the same thread of execution, behavior can be CONSTRAINED UNPREDICTABLE with the following behavior:

对加载-独占（Load-Exclusive）与存储-独占（Store-Exclusive）指令的一种实现可以要求：在任一执行线程中，存储-独占（StoreExcl）指令的事务大小（transaction size）必须与该线程中先前执行的加载-独占（LoadExcl）指令的事务大小相同。如果同一线程中存储-独占指令的事务大小与先前的加载-独占指令的事务大小不同，则其行为可能为“受约束的不可预测（CONSTRAINED UNPREDICTABLE）”，并遵循以下行为：

注意：
  require: 要求，强制性，绝对化的规范
  can require  : 能够要求，可以要求，这就是可选的规范了
```

### 使用相同数量的寄存器 [可选]
```txt
An implementation of the LoadExcl and StoreExcl instructions can require that, in any thread of execution, the StoreExcl instruction accesses the same number of registers as the preceding LoadExcl instruction executed in that thread. If the StoreExcl instruction accesses a different number of registers than the preceding LoadExcl instruction in the same thread of execution, behavior is CONSTRAINED UNPREDICTABLE. As a result, software can rely on an LoadExcl/StoreExcl pair to eventually succeed only if they access the same number of registers. For more information, see CONSTRAINED UNPREDICTABLE behavior when Load-Exclusive/Store-Exclusive access a different number of registers.
```

### Tag Checked 属性 [可选]
> 什么是Tag Checked属性?

```txt
This means software can rely on a LoadExcl/StoreExcl pair to eventually succeed only if the memory is accessed with a compatible Tag Checked property.
```

### LoadExcl/StoreExcl loops are guaranteed to make forward progress
> LoadExcl/StoreExcl 继续执行(顺利执行的条件)

- LoadExcl/StoreExcl 中间不能有其他指令
- Between the Store-Exclusive returning a failing result and the retry of the corresponding Load-Exclusive: (在存储独占（Store-Exclusive）指令返回失败结果与重试对应加载独占（Load-Exclusive）指令的间隔期间)
  + There are no stores or PRFM or RPRFM instructions to any address within the Exclusives reservation granule accessed by the Store-Exclusive. This includes VA aliases to those addresses.（在存储独占（Store-Exclusive）指令访问的独占保留粒度（Exclusives reservation granule）范围内的任何地址上，都不会存在存储指令、PRFM（预取内存）或 RPRFM（带相对偏移的预取内存）指令的操作。此限制还包括这些地址的虚拟地址（VA）别名）
  + There are no loads or prefetches to any address within the Exclusives reservation granule accessed by the Store-Exclusive that use a different VA alias to that address(对于存储独占（Store-Exclusive）指令访问的独占保留粒度范围内的任何地址，都不会存在使用与该地址不同的虚拟地址（VA）别名进行加载或预取操作的情况)
  + There are no other Store-Exclusive instructions to any other address. (不能有对任何其他地址的存储-独占指令的操作)
  + There are no other Store-Exclusive instructions to any other address.
  + There are no direct or indirect System register writes, address translation instructions, cache or TLB maintenance instructions, exception generating instructions, exception returns, indirect branches, or Branch with Link instructions(没有直接或间接系统寄存器写入操作、地址翻译指令、...)
  + All loads and stores are to a block of contiguous<sup>连续的；邻近的；接触的</sup> virtual memory of not more than 512 bytes in size.